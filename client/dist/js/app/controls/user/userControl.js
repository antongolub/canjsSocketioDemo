define(["can","controls/defaultControl","text!templates/user/user.hbs","models/userModel","assets/pushstate"],function(e,n,o,t,r){var s="b-section--error",l="b-section--new";return n.extend({init:function(){var n=this;e.view.mustache("userHbs",o),e.view("userHbs",n.model,function(e){n.element=n.element.append(e).find("#user"),n.$formElements=n.element.find("input, select, textarea"),n.$error=n.element.find(".controlError"),n.element.on("click","#save, #add",$.proxy(n.save,n)),n.element.on("click","#remove",$.proxy(n.remove,n))}),n.model.bind("change",$.proxy(n.onModelChange,n))},model:new t,fetch:function(e){var n,o=this;return o.id=(e||{}).id,o.id&&(n=o.model.findOne(e.id).done($.proxy(o.onModelUpdate,o))),n},save:function(){var e,n=this;return n.$formElements.trigger("change"),e=n.model.errors(),e?e:n.model.update().done($.proxy(n.onModelSave,n))},remove:function(){var e=this;return r("/users","Users",!0),e.model.destroy()},toggleViewMode:function(e){var n,o=this,t="new"===o.id;o.element.toggleClass(l,t),t?(o.model.attr("id",null),o.$formElements.val(""),o.id=null):e||(n="User {id:"+o.id+"} not found",o.$error.html(n)),o.element.toggleClass(s,!!n)},onModelChange:function(e,n){return this.showError(n)},onModelSave:function(n){e.route.attr("id",n.id),this.element.removeClass(l)},onModelUpdate:function(e){this.toggleViewMode(e)},show:function(e){var n=this;n.element.show(),n.fetch(e)}})});